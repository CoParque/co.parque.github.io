<!DOCTYPE html>
<html>

<head>
	<title>Informe de predicación telefónica</title>
	<meta name="robots" content="noindex" />
	<meta name="robots" content="nofollow" />
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" href="/favicon.ico">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.css">
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsonata@1.6.4/jsonata.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.js"></script>
	<link href="/app/css/bootstrap.min.css" rel="stylesheet">
	<script>
	/*
		$(window).on('message',function(e){
		alert('Mensaje del iframe');
		console.log("MESSAGE",e);
			
		});
		
		$(document).on('click', 'a[rel=modal]', function(e) {
			e.stopImmediatePropagation();
			e.preventDefault();
			var modal = $('#modal').modal();
			console.log('hey')
			modal.find('.modal-body').load($(this).attr('href'), function(responseText, textStatus) {
				if(textStatus === 'success' || textStatus === 'notmodified') {
					$('#miframe').attr('src',"detalle.html?telefono=(343)%20424%20-%200288")
					modal.show();
				}
			});
		});*/
	var $table = $('#table');
      var tipo = "contactos";
      var zona = "parana";
      var data;

	function loadJson() {
		$('#cargando').modal('show');
		$.getJSON('https://sheets.googleapis.com/v4/spreadsheets/1VGOPLJ19ms7Xi1NyLFE83cjAkq3OrffrwRjjxgcgSQ4/values/telefonos?alt=json&key=AIzaSyCz4sutc6Z6Hh5FtBTB53I8-ljkj6XWpPc').done(function(jsonurl) {
			data = jsonata('$.values.({"Telefono":$[0], "Direccion":$[1], "Localidad":$[2], "Fecha":$[3], "Respuesta":$[4], "Publicador":$[5], "Turno":$[6], "Observaciones":$[7], "Responsable":$[8]&""})').evaluate(jsonurl);
filterJson();
		});
	};
      function filterJson() {
        $('#cargando').modal('show');
        var filtro = data;
        switch(zona) {
  case "parana":
    filtro =  jsonata('[$[Localidad="Paraná"]]').evaluate(filtro);
    break;
  case "interior":
    filtro =  jsonata('[$[Localidad!="Paraná"]]').evaluate(filtro);
};
switch(tipo) {
  case "contactos":
    filtro =  jsonata('[$[Respuesta!="Reservado"],{}]').evaluate(filtro);
    $("#tablecontactos").attr("class", "table-responsive show");
    $("#tablereservas").attr("class", "table-responsive hidden");
    break;
  case "reservas":
    filtro =  jsonata('[$[Respuesta="Reservado"],{}]').evaluate(filtro);
    $("#tablecontactos").attr("class", "table-responsive hidden");
    $("#tablereservas").attr("class", "table-responsive show");
};    
  console.log(filtro);     
        if (filtro) {
          filtro =  jsonata('$.{"Telefono":Telefono, "Direccion":Direccion & ", "& Localidad, "Respuesta":Respuesta &" ("& Fecha &$string(Turno = "" ? ")": " por la "& Turno &")"), "PublicadorFecha":Publicador &" ("& Fecha &")", "Responsable":Responsable}').evaluate(filtro);
          

          $("#alert").attr("class", "alert alert-warning hidden");
            $('#table').bootstrapTable({
				data: filtro
			});
			$('#table').bootstrapTable('load', filtro);
          
            $('#tableres').bootstrapTable({
				data: filtro
			});
			$('#tableres').bootstrapTable('load', filtro);
        } else {
          $("#tablecontactos").attr("class", "table-responsive hidden");
          $("#tablereservas").attr("class", "table-responsive hidden");
          $("#alert").attr("class", "alert alert-warning show");
        };
        
       

			$('#cargando').modal('hide');
        };
	loadJson();
	var win;

	function LinkFormatter(value, row, index) {
        switch(tipo) {
  case "contactos":
   return "<a href='javascript:win = window.open(&apos;reservar.html?telefono=" + value + "&apos;);'>" + value + "</a>";
    break;
  case "reservas":
    return "<a href='javascript:win = window.open(&apos;informar.html?telefono=" + value + "&apos;);'>" + value + "</a>";
} ;    
		
	};
	window.addEventListener('message', event => {
		// Only accept messages from http://example.com.
		if(event.origin === 'https://churruar.in') {
			win.close()
			loadJson();
		}
	});
    $(document).ready(function() {
        $("#parana").click(function(){
   			$("#parana").attr("class", "active");
          	$("#interior").attr("class", "");
          zona = "parana";
          filterJson();
		});
         $("#interior").click(function(){
   			$("#parana").attr("class", "");
          	$("#interior").attr("class", "active");
          zona = "interior";
           filterJson();
		});
        $("#contactos").click(function(){
   			$("#contactos").attr("class", "btn btn-info active");
          	$("#reservas").attr("class", "btn btn-warning");
            $("#titulo").text("Contactos disponibles para predicación telefónica");
          tipo = "contactos";
          loadJson();
		});
        $("#reservas").click(function(){
   			$("#contactos").attr("class", "btn btn-info");
          	$("#reservas").attr("class", "btn btn-warning active");
            $("#titulo").text("Contactos reservados para predicación telefónica");
          tipo = "reservas";
          loadJson();
		});
    });
	</script>
</head>

<body role="document">
	<div class="container">
		<div class="btn-group pull-right" role="group" aria-label="...">
			<button type="button" id="contactos" class="btn btn-info active">Contactos</button>
			<button type="button" id="reservas" class="btn btn-warning">Reservas</button>
		</div>

		<h1 id="titulo">Contactos disponibles para predicación telefónica</h1>
      	<ul class="nav nav-tabs padding-top-md">
			<li role="presentation" id="parana" class="active"><a href="#">Paraná</a></li>
			<li role="presentation" id="interior" ><a href="#">Interior</a></li>
		</ul>
      <div class="alert alert-info alert-dismissible" role="alert">
  <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
  No olvides <strong>reservar</strong> el contacto <strong>antes</strong> de pasárselo a un hermano.
</div>
		<div class="table-responsive show" id="tablecontactos">
			<table id="table" data-toggle="table" class="table table-striped">
				<thead>
					<tr>
						<th data-field="Telefono" data-formatter="LinkFormatter">Teléfono</th>
						<th data-field="Direccion">Dirección</th>
						<th data-field="Respuesta">Última respuesta</th>
					</tr>
				</thead>
			</table>
		</div>
      	<div class="table-responsive hidden" id="tablereservas">
			<table id="tableres" data-toggle="tableres" class="table table-striped">
				<thead>
					<tr>
						<th data-field="Telefono" data-formatter="LinkFormatter">Teléfono</th>
						<th data-field="PublicadorFecha">Publicador</th>
                      	<th data-field="Responsable">Responsable</th>
					</tr>
				</thead>
			</table>
		</div>
      <div class="alert alert-warning hidden" role="alert" id="alert">No hay contactos disponibles.</div>
</div>
	</div>
	<div class="modal fade" id="cargando" tabindex="-1" role="dialog">
		<p>Cargando...</p>
	</div>
	<!-- /.modal -->
</body>

</html>