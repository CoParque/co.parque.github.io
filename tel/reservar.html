<!DOCTYPE html>
<html>

<head>
	<title>Territorio para predicación telefónica</title>
	<meta name="robots" content="noindex" />
	<meta name="robots" content="nofollow" />
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="icon" href="/favicon.ico">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/jsonata@1.6.4/jsonata.min.js"></script>
	<link href="/app/css/bootstrap.min.css" rel="stylesheet">
	<script>
	var getUrlParameter = function getUrlParameter(sParam) {
		var sPageURL = window.location.search.substring(1),
			sURLVariables = sPageURL.split('&'),
			sParameterName,
			i;
		for(i = 0; i < sURLVariables.length; i++) {
			sParameterName = sURLVariables[i].split('=');
			if(sParameterName[0] === sParam) {
				return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
			}
		}
	};
	var telefono = getUrlParameter('telefono');
	var registrotel;
      var pubs;
      var linkwa;
	console.log(telefono);
	$(function() {
		$('#cargando').modal('show');
		$.getJSON('https://sheets.googleapis.com/v4/spreadsheets/1VGOPLJ19ms7Xi1NyLFE83cjAkq3OrffrwRjjxgcgSQ4/values/telefonos?alt=json&key=AIzaSyCz4sutc6Z6Hh5FtBTB53I8-ljkj6XWpPc').done(function(jsonurl) {
			var data = jsonata('$.values.({"Telefono":$[0], "Direccion":$[1], "Localidad":$[2], "Fecha":$[3], "Respuesta":$[4], "Publicador":$[5], "Turno":$[6], "Observaciones":$[7]})').evaluate(jsonurl);
			registrotel = jsonata('$[Telefono="' + telefono + '"]').evaluate(data);
			console.log(registrotel);
			$("#Telefono").text(registrotel['Telefono']);
			$("#Direccion").text(registrotel['Direccion']);
			$("#Localidad").text(registrotel['Localidad']);
			$("#Fecha").text(registrotel['Fecha']);
			$("#Respuesta").text(registrotel['Estado']);
			$("#Observaciones").text(registrotel['Observaciones']);
			$("#informar").attr("href", "informar.html?telefono=" + registrotel['Telefono']);
			$('#cargando').modal('hide');
		});
		$.getJSON('https://sheets.googleapis.com/v4/spreadsheets/1VGOPLJ19ms7Xi1NyLFE83cjAkq3OrffrwRjjxgcgSQ4/values/pubs?alt=json&key=AIzaSyCz4sutc6Z6Hh5FtBTB53I8-ljkj6XWpPc').done(function(jsonurl) {
			pubs = jsonata('$.values.({"Nombre":$[0],"Tel":$[2]})').evaluate(jsonurl);
			var listitems = '';
			$.each(pubs, function(key, value) {
				listitems += '<option>' + value['Nombre'] + '</option>';
			});
			$("#Publicador").append(listitems);
		});
	});
      $(document).ready(function() {
          $("#cancelar").click(function(){
            
    window.opener.postMessage('close', 'https://churruar.in')
});
        
         $("#Publicador").change(function(){
           var selpub = $("#Publicador").find(":selected").text()
           var selpubtel = jsonata('$[Nombre="' + selpub + '"].Tel').evaluate(pubs);
          // 
           linkwa = "https://wa.me/"+ if (selpubtel) {"+54" + selpubtel} + "?text=" + encodeURIComponent("_Co. Churruarín_ \r\n*ASIGNACIÓN DE TERRITORIO TELEFÓNICO* \n\nSe te asignó el siguiente número telefónico para que lo atiendas: \nNúmero: *" + registrotel['Telefono'] + "*\nDirección: *" + registrotel['Direccion'] + "*\nFue llamado la última vez en: *"+ registrotel['Fecha'] + "*\nRespuesta a la última llamada: *" + registrotel['Estado'] +"*\n\nPor favor, *no olvides informar* la respuesta del amo de casa al hermano que te asignó este número. Llevar un buen registro es esencial para dar un buen testimonio. \nPor favor, incluí en tu respuesta estos datos: \n*Teléfono:* \n*Respuesta* (Opciones: atendió / no atendió / no existente / no volver a llamar / mensaje en el contestador / revisita): \n*Fecha de la llamada:* \n*Turno de la llamada* (mañana o tarde): \n*Observaciones* (opcional): \nSi deseás reservar el número como *revisita*, por favor no olvides informarle al hermano cuando ya no lo sigas revisitando. Gracias.")

});
  $("#enviar").click(function(){
       window.open(linkwa);
    window.opener.postMessage('close', 'https://churruar.in');
});
        
        });
	</script>
</head>

	<body role="document">
      
      
	<div class="container">
      <h1>Reserva de contacto para predicación telefónica</h1>
  <form class="form-horizontal" name="submit-to-google-sheet">
	<dl class="dl-horizontal"> 
      			<div class="panel panel-default">
				<div class="panel-heading">
					<h3 class="panel-title">Datos del contacto</h3> </div>
				<div class="panel-body">
      <dt>Teléfono</dt>
		<dd id="Telefono">...</dd> <dt>Dirección</dt>
		<dd id="Direccion">...</dd> 
      <dt>Localidad</dt>
		<dd id="Localidad">...</dd>
                  </div></div>
      <div class="panel-body">
      <dt>Asignar a publicador</dt>
		<dd>				<select id="Publicador" name="Publicador" class="select form-control" required="required">
					<option></option>
          </select></dd></div>
	</dl> <p class="text-right">
	 <button class="btn btn-success" id="enviar" type="submit">Reservar y enviar</button>
      <a class="btn btn-info" id="reservar" href="#" role="button">Reservar</a>
    <a class="btn btn-default" id="cancelar" href="#" role="button">Cancelar</a></p>
		</form>
      </div>
	<div class="modal fade" id="cargando" tabindex="-1" role="dialog">
<p>Cargando...</p>
	</div>
	<!-- /.modal -->
      
      <script src="/app/js/formdata-polyfill.js"></script>
<script src="/app/js/promise-polyfill.js"></script>
<script src="/app/js/whatwg-fetch.js"></script>

<script>
      $(document).ready(function(){
      var date_input=$('input[name="Fecha"]'); //our date input has the name "date"
      var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
      var options={
    format: "dd/mm/yyyy",
    todayBtn: "linked",
    language: "es",
    daysOfWeekHighlighted: "0,6",
    todayHighlight: true
      };
      date_input.datepicker(options);
    });

  
  
  const scriptURL = 'https://script.google.com/macros/s/AKfycbzivt4eVHnlJKOwMIHFq6n200v8eMOkx8qNJOgFf08R-ncjqa_r/exec'
  const form = document.forms['submit-to-google-sheet']

  form.addEventListener('submit', e => {
    e.preventDefault()
    fetch(scriptURL, { method: 'POST', body: new FormData(form)})
      .then(response => console.log('Success!', response))
      .catch(error => console.error('Error!', error.message))
  })
</script>
      
</body>

</html>